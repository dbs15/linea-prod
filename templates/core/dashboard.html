{% extends 'base.html' %}

{% block title %}{{ dashboard_title }} - Sistema de Maquilas{% endblock %}

{% block content %}
{% if dashboard_type == 'super_admin' %}
    <!-- Dashboard Super Admin -->
    <div class="min-h-screen bg-gradient-to-br from-coffee-50 to-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ dashboard_title }}</h1>
                        <p class="text-gray-600">{{ dashboard_description }}</p>
                    </div>
                    <a href="{% url 'core:crear_empresa' %}" class="btn-coffee text-lg px-6 py-3 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                        <i class="fas fa-plus-circle mr-2"></i>
                        Nueva Empresa
                    </a>
                </div>
            </div>

            <!-- Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card-glass text-center transform hover:scale-105 transition-transform duration-300">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full mb-4 shadow-lg">
                        <i class="fas fa-building text-2xl text-white"></i>
                    </div>
                    <h3 class="text-4xl font-bold text-blue-600 mb-2">{{ total_companies }}</h3>
                    <p class="text-gray-700 font-medium">Total Empresas</p>
                    <p class="text-sm text-gray-500 mt-1">Registradas</p>
                </div>

                <div class="card-glass text-center transform hover:scale-105 transition-transform duration-300">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-green-500 to-green-600 rounded-full mb-4 shadow-lg">
                        <i class="fas fa-check-circle text-2xl text-white"></i>
                    </div>
                    <h3 class="text-4xl font-bold text-green-600 mb-2">{{ active_companies }}</h3>
                    <p class="text-gray-700 font-medium">Empresas Activas</p>
                    <p class="text-sm text-gray-500 mt-1">Operativas</p>
                </div>

                <div class="card-glass text-center transform hover:scale-105 transition-transform duration-300">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-red-500 to-red-600 rounded-full mb-4 shadow-lg">
                        <i class="fas fa-pause-circle text-2xl text-white"></i>
                    </div>
                    <h3 class="text-4xl font-bold text-red-600 mb-2">{{ suspended_companies }}</h3>
                    <p class="text-gray-700 font-medium">Empresas Suspendidas</p>
                    <p class="text-sm text-gray-500 mt-1">Inactivas</p>
                </div>

                <div class="card-glass text-center transform hover:scale-105 transition-transform duration-300">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full mb-4 shadow-lg">
                        <i class="fas fa-users text-2xl text-white"></i>
                    </div>
                    <h3 class="text-4xl font-bold text-purple-600 mb-2">{{ total_users }}</h3>
                    <p class="text-gray-700 font-medium">Total Usuarios</p>
                    <p class="text-sm text-gray-500 mt-1">En el sistema</p>
                </div>
            </div>

            <!-- Company Management -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Active Companies -->
                <div class="card-glass">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-building text-green-600 mr-3"></i>
                            Empresas Activas
                        </h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            {{ active_companies_list|length }}
                        </span>
                    </div>
                    <div class="space-y-4">
                        {% for company in active_companies_list %}
                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-building text-white text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900">{{ company.name }}</h4>
                                        <p class="text-sm text-gray-600">{{ company.nit }}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="toggleCompanyStatus({{ company.id }}, 'suspend')"
                                            class="btn-danger text-xs px-3 py-1">
                                        <i class="fas fa-pause mr-1"></i>Suspender
                                    </button>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-gray-500 text-center py-4">No hay empresas activas</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Suspended Companies -->
                <div class="card-glass">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-building text-red-600 mr-3"></i>
                            Empresas Suspendidas
                        </h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            {{ suspended_companies_list|length }}
                        </span>
                    </div>
                    <div class="space-y-4">
                        {% for company in suspended_companies_list %}
                            <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-200">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-building text-white text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900">{{ company.name }}</h4>
                                        <p class="text-sm text-gray-600">{{ company.nit }}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="toggleCompanyStatus({{ company.id }}, 'activate')"
                                            class="btn-success text-xs px-3 py-1">
                                        <i class="fas fa-play mr-1"></i>Activar
                                    </button>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-gray-500 text-center py-4">No hay empresas suspendidas</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card-glass">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-history text-blue-600 mr-3"></i>
                        Actividad Reciente
                    </h3>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ recent_activity|length }}
                    </span>
                </div>
                <div class="space-y-4">
                    {% for activity in recent_activity %}
                        <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white text-xs"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">
                                    {{ activity.user.get_full_name }}
                                    {% if activity.company %}
                                        <span class="text-gray-500">en {{ activity.company.name }}</span>
                                    {% endif %}
                                </p>
                                <p class="text-sm text-gray-600">{{ activity.description }}</p>
                                <p class="text-xs text-gray-500">{{ activity.timestamp|timesince }} atrás</p>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-gray-500 text-center py-4">No hay actividad reciente</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

{% elif dashboard_type == 'company_user' %}
    <!-- Dashboard Usuario de Empresa -->
    <div class="min-h-screen bg-gradient-to-br from-coffee-50 to-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ dashboard_title }}</h1>
                <p class="text-gray-600">{{ dashboard_description }}</p>
            </div>

            <!-- Company Info & Metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                <!-- Company Info -->
                <div class="card-glass lg:col-span-1">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-coffee-500 to-coffee-700 rounded-full mb-4 shadow-lg">
                            <i class="fas fa-building text-2xl text-white"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-2">{{ company.name }}</h3>
                        <p class="text-sm text-gray-600 mb-4">{{ company.nit }}</p>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Plan:</span>
                                <span class="font-medium">{{ company.get_plan_display }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Estado:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if company.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ company.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card-glass text-center">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-500 rounded-full mb-3">
                            <i class="fas fa-shopping-cart text-white"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-blue-600">{{ metrics.total_orders }}</h4>
                        <p class="text-gray-700 font-medium">Total Pedidos</p>
                    </div>

                    <div class="card-glass text-center">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-orange-500 rounded-full mb-3">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-orange-600">{{ metrics.active_orders }}</h4>
                        <p class="text-gray-700 font-medium">Pedidos Activos</p>
                    </div>

                    <div class="card-glass text-center">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-green-500 rounded-full mb-3">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-green-600">{{ metrics.total_clients }}</h4>
                        <p class="text-gray-700 font-medium">Total Clientes</p>
                    </div>
                </div>
            </div>

            <!-- Modules Grid -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Módulos del Sistema</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                    {% for module in modules %}
                        <a href="{% url module.url %}"
                           class="card-glass group hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
                            <div class="text-center p-6">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r {{ module.color }}-500 to-{{ module.color }}-600 rounded-full mb-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                                    <i class="{{ module.icon }} text-2xl text-white"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ module.name }}</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">{{ module.description }}</p>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card-glass">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-history text-blue-600 mr-3"></i>
                        Actividad Reciente de {{ company.name }}
                    </h3>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ company_activity|length }}
                    </span>
                </div>
                <div class="space-y-4">
                    {% for activity in company_activity %}
                        <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white text-xs"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">
                                    {{ activity.user.get_full_name }}
                                </p>
                                <p class="text-sm text-gray-600">{{ activity.description }}</p>
                                <p class="text-xs text-gray-500">{{ activity.timestamp|timesince }} atrás</p>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-gray-500 text-center py-4">No hay actividad reciente</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

{% else %}
    <!-- Dashboard Genérico / Sin Empresa -->
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-white">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-gray-400 to-gray-500 rounded-full mb-8 shadow-lg">
                    <i class="fas fa-exclamation-triangle text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ dashboard_title }}</h1>
                <p class="text-xl text-gray-600 mb-8">{{ dashboard_description }}</p>
                <p class="text-gray-500">
                    Contacta al administrador del sistema para obtener acceso completo.
                </p>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// Company status toggle functionality
function toggleCompanyStatus(companyId, action) {
    if (!confirm(`¿Estás seguro de que quieres ${action === 'suspend' ? 'suspender' : 'activar'} esta empresa?`)) {
        return;
    }

    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Procesando...';
    button.disabled = true;

    fetch('{% url "core:toggle_company_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `company_id=${companyId}&action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showMessage(data.message, 'success');

            // Reload page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showMessage(data.error || 'Error desconocido', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error de conexión', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Message display function
function showMessage(message, type) {
    const messagesContainer = document.querySelector('.messages') || document.body;

    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    messageDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;

    messagesContainer.appendChild(messageDiv);

    // Animate in
    setTimeout(() => {
        messageDiv.classList.remove('translate-x-full');
    }, 100);

    // Auto remove
    setTimeout(() => {
        messageDiv.classList.add('translate-x-full');
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Add loading states to buttons
    const buttons = document.querySelectorAll('button[onclick*="toggleCompanyStatus"]');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Prevent double clicks
            if (this.disabled) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}